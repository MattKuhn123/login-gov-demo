<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Login Gov Demo</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width" />
    <base href="/" />
    <link rel="stylesheet" type="text/css" href="/webjars/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="./style.css" />
    <script type="importmap">
        {
            "imports": {
                "bootstrap": "/webjars/bootstrap/dist/js/bootstrap.esm.min.js",
                "@popperjs/core": "/webjars/popperjs__core/lib/index.js",
                "htmx": "/webjars/htmx.org/dist/htmx.min.js",
                "md": "https://md-block.verou.me/md-block.js"
            }
        }
    </script>
    <script type="module">
        import 'bootstrap';
        import 'htmx';
        import 'md';
    </script>

</head>

<body>
    <header>
        <nav class="nav nav-tabs">
            <a class="nav-link active" data-bs-toggle="tab" data-bs-target="#about" href="#">About</a>
            <a class="nav-link" data-bs-toggle="tab" data-bs-target="#login-gov-setup" href="#">Login Dot Gov Setup</a>
            <a class="nav-link" data-bs-toggle="tab" data-bs-target="#your-development-info" href="#">Development</a>
            <a class="nav-link" data-bs-toggle="tab" data-bs-target="#your-development-guide" href="#">Guide</a>
            <a class="nav-link" data-bs-toggle="tab" data-bs-target="#your-application" href="#">Your Application</a>
        </nav>
    </header>
    <main>
        <div class="tab-content">
            <div class="tab-pane fade show" id="your-application" role="tabpanel">
                <div class="jumbotron">
                    <h1 class="display-4">Your application</h1>
                    <a class="btn btn-danger" id="refresh-your-application">
                        Refresh your application
                    </a>
                    <hr>
                </div>
                <div id="your-application-placeholder" hx-trigger="click from:#refresh-your-application" hx-get="./your-application-todo.html">
                    Click the button above to refresh... 
                </div>
            </div>

            <div class="tab-pane fade show active" id="about" role="tabpanel">
                <div class="jumbotron">
                    <h1 class="display-4">About</h1>
                    <p class="lead">What is login dot gov and what are we doing?</p>
                </div>

                <div class="container nav-container">
                    <div class="card" style="width: 18rem;">
                        <img class="card-img-top" src="./images/logingov-logo.png" alt="login dot gov logo">
                        <div class="card-body">
                            <h5 class="card-title">Login Dot Gov</h5>
                            <p class="card-text">Login dot gov is a 3rd party authentication service that you can
                                integrate into your application to authenticate users with MFA.</p>
                            <a href="https://developers.login.gov/" class="btn btn-primary" target="_blank">Developer Dashboard</a>
                        </div>
                    </div>
                    <div class="card" style="width: 18rem;">
                        <img class="card-img-top" src="./images/logingov-logo.png" alt="login dot gov logo">
                        <div class="card-body">
                            <h5 class="card-title">This demo</h5>
                            <p class="card-text">In this demo, we are going to create a demo application that uses
                                login.gov's sandbox environment to authenticate users. We are using VS Code and Spring Initialzr</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade show" id="login-gov-setup" role="tabpanel">
                <div class="jumbotron">
                    <h1 class="display-4">Login Dot Gov Setup</h1>
                    <p class="lead">Create resources in login dot gov.</p>
                </div>
                <div class="container nav-container">
                    <div class="card" style="width: 18rem;">
                        <img class="card-img-top" src="./images/logingov-logo.png" alt="login dot gov logo">
                        <div class="card-body">
                            <h5 class="card-title">Create a user account</h5>
                            <p class="card-text">This will be your personal account that you will use, not only to
                                create the resources in login.gov, but also to sign in to the demo application</p>
                            <a href="https://idp.int.identitysandbox.gov/sign_up/enter_email/" class="btn btn-primary"
                                target="_blank">Create account</a>
                        </div>
                    </div>
                    <div class="card" style="width: 18rem;">
                        <img class="card-img-top" src="./images/logingov-logo.png" alt="login dot gov logo">
                        <div class="card-body">
                            <h5 class="card-title">Create a team</h5>
                            <p class="card-text">An app must be associated with a team. For agency, use <span
                                    class="text-danger">Tennessee Valley
                                    Authority</span></p>
                            <a href="https://dashboard.int.identitysandbox.gov/teams" class="btn btn-primary"
                                target="_blank">Create team</a>
                        </div>
                    </div>
                    <div class="card" style="width: 18rem;">
                        <img class="card-img-top" src="./images/logingov-logo.png" alt="login dot gov logo">
                        <div class="card-body">
                            <h5 class="card-title">Create an application</h5>
                            <ul class="card-text">
                                <li>Set authentication protocol to <span class="text-danger">OpenID Connect Private Key JWT</span></li>
                                <li>Set Level of Service to <span class="text-danger">Authentication only</span></li>
                                <li>Check <span class="text-danger">email</span> for Attribute Bundle</li>
                                <li>For Issuer, I'll be using <span class="text-danger">gov:gsa:openidconnect.profiles:sp:sso:tva:kuhn_demo</span></li>
                                <li>Follow their instructions to create a public/private key. For the purposes of this
                                    demo, I'm putting both in <span class="text-danger">src/main/resources/security</span> of
                                    this project</li>
                                <li>For Redirect URIs, I'll be using <span class="text-danger">http://localhost:8080/Redirect</span></li>
                            </ul>
                            <a href="https://dashboard.int.identitysandbox.gov/service_providers"
                                class="btn btn-primary" target="_blank">Create application</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade show" id="your-development-info" role="tabpanel">
                <div class="jumbotron">
                    <h1 class="display-4">Info</h1>
                    <p class="lead">You will be modifying these files.</p>
                </div>
                <div class="container nav-container">
                    <div id="front-end" class="card" style="width: 18rem;">
                        <img class="card-img-top" src="./images/html.png" alt="html icon">
                        <div class="card-body">
                            <h5 class="card-title">Front-end</h5>
                            <p class="card-text"><span class="text-danger">src/main/resources/static/your-application-todo.html</span></p>
                        </div>
                    </div>
                    <div id="filter-chains" class="card" style="width: 18rem;">
                        <img class="card-img-top" src="./images/filter.png" alt="filter icon">
                        <div class="card-body">
                            <h5 class="card-title">Filter-chains</h5>
                            <p class="card-text"><span class="text-danger">kuhn.example.logingovdemo.YourJwtAuthenticationFilter.java</span></p>
                            <p class="card-text"><span class="text-danger">kuhn.example.logingovdemo.YourLoginFilter.java</span></p>
                        </div>
                    </div>
                    <div id="controllers" class="card" style="width: 18rem;">
                        <img class="card-img-top" src="./images/padlock-open.png" alt="unauthenticated icon">
                        <div class="card-body">
                            <h5 class="card-title">Controllers</h5>
                            <p class="card-text"><span class="text-danger">kuhn.example.logingovdemo.YourUnauthenticatedRestController.java</span></p>
                            <p class="card-text"><span class="text-danger">kuhn.example.logingovdemo.YourAuthenticatedRestController.java</span></p>
                        </div>
                    </div>
                    <div id="see-app" class="card" style="width: 18rem;">
                        <img class="card-img-top" src="./images/share.png" alt="share icon">
                        <div class="card-body">
                            <h5 class="card-title">See your app</h5>
                            <p class="card-text">Your app will be in the <span class="text-danger">Your Application</span> tab.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade show" id="your-development-guide" role="tabpanel">
                <div class="jumbotron">
                    <h1 class="display-4">Guide</h1>
                    <p class="lead">Guide you through the code changes of your application.</p>
                </div>

                <div class="container nav-container-vertical">
                    <div id="create-a-test-endpoint" class="card" style="width: 60rem;">
                        <div class="card-body">
                            <h5 class="card-title">Create a test endpoint</h5>
                            <p class="card-text">Let's demonstrate how to request from the front-end to the back end.</p> 
                            <p>Add the following endpoint to <span class="text-danger">kuhn.example.logingovdemo.YourUnauthenticatedRestController</span>.</p>
                            <md-block>
                                ``` java
                                @GetMapping("/random")
                                public String randomNumber() {
                                    System.out.println("In unauthenticated endpoint");
                                    return String.valueOf(new Random().nextInt());
                                }
                                ```
                            </md-block>

                            <p class="card-text">And add the following button to <span class="text-danger">src/main/resources/static/your-application-todo.html</span>.</p>
                            <md-block>
                                ```html
                                &lt;a class="btn btn-primary" hx-trigger="click" hx-get="/random">
                                    Click me
                                &lt;/a>
                                ```
                            </md-block>
                            <p class="card-text">Now, if you click on the <span class="text-danger">Your Application</span> tab, you should see a random number displayed.</p>
                        </div>
                    </div>

                    <div id="create-an-authenticated-endpoint" class="card" style="width: 60rem;">
                        <div class="card-body">
                            <h5 class="card-title">Create an authenticated endpoint</h5>
                            <p class="card-text">Let's suppose that one of the endpoints needs to be authenticated.</p>
                            <p class="card-text">Add the following endpoint to <span class="text-danger">kuhn.example.logingovdemo.YourAuthenticatedRestController</span>.</p>
                            <md-block>
                                ``` java
                                @GetMapping("/random")
                                public String randomNumber() {
                                    System.out.println("In authenticated endpoint");
                                    return "(auth) " + String.valueOf(new Random().nextInt());
                                }
                                ```
                            </md-block>

                            <p class="card-text">And add the following button to the end of <span class="text-danger">src/main/resources/static/your-application-todo.html</span></p>
                            <md-block>
                                ```html
                                &lt;a class="btn btn-primary" hx-trigger="click" hx-get="/auth/random">
                                    (auth) Click me
                                &lt;/a>
                                ```
                            </md-block>

                            <p class="card-text">Now you have <span class="text-danger">two</span> buttons; one for an authenticated endpoint, and the other for an unauthenticated enpoint.</p>
                        </div>
                    </div>

                    <div id="use-the-filter-chain" class="card" style="width: 60rem;">
                        <div class="card-body">
                            <h5 class="card-title">Use the filter chain</h5>
                            <p class="card-text">Add the following filter to <span class="text-danger">kuhn.example.logingovdemo.YourJwtAuthenticationFilter</span>.</p>
                            <md-block>
                                ``` java
                                @Override
                                public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
                                        throws IOException, ServletException {
                                    System.out.println("entering chain!");
                                    chain.doFilter(request, response);
                                    System.out.println("exiting chain!");
                                }
                                ```
                            </md-block>

                            <p class="card-text">Click the buttons on your front-end a few times, and note the <span class="text-danger">logs</span> printed to the console.</p>
                            <md-block>
                                ``` bash
                                    entering chain!
                                    In unauthenticated endpoint
                                    exiting chain!
                                    entering chain!
                                    In authenticated endpoint
                                    exiting chain!
                                ```
                            </md-block>
                        </div>
                    </div>

                    <div id="filter-requests-with-the-filter-chain" class="card" style="width: 60rem;">
                        <div class="card-body">
                            <h5 class="card-title">Filter requests with the filter chain</h5>
                            <p class="card-text">Add the following to <span class="text-danger">kuhn.example.logingovdemo.YourJwtAuthenticationFilter</span>.</p>
                            <md-block>
                                ``` java
                                @Bean
                                public FilterRegistrationBean<YourJwtAuthenticationFilter> jwtFilter() {
                                    FilterRegistrationBean<YourJwtAuthenticationFilter> registrationBean = new FilterRegistrationBean<>();
                                    registrationBean.setFilter(new YourJwtAuthenticationFilter());
                                    registrationBean.addUrlPatterns("/auth/*");
                                    return registrationBean; 
                                }
                                ```
                            </md-block>

                            <p class="card-text">Click the buttons on your front-end a few times, and note the <span class="text-danger">logs</span> printed to the console.</p>
                            <md-block>
                                ``` bash
                                    In unauthenticated endpoint
                                    entering chain!
                                    In authenticated endpoint
                                    exiting chain!
                                ```
                            </md-block>

                            <p class="card-text">Now the filter chain is only being applied to requests with <span class="text-danger">/auth</span> in the request uri.</p>
                        </div>
                    </div>

                    <div id="deny-requests-with-the-filter-chain" class="card" style="width: 60rem;">
                        <div class="card-body">
                            <h5 class="card-title">Deny requests with the filter chain</h5>
                            <p class="card-text">Rewrite <span class="text-danger">kuhn.example.logingovdemo.YourJwtAuthenticationFilter.doFilter()</span> like so:</p>
                            <md-block>
                                ``` java
                                @Override
                                public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
                                        throws IOException, ServletException {
                                    System.out.println("entering chain!");
                                    final String val = ((HttpServletRequest) request).getHeader("token");
                                    if (val == null || val == "") {
                                        ((HttpServletResponse) response).sendError(HttpServletResponse.SC_UNAUTHORIZED, 
                                                "The token is not valid.");
                                    } else {
                                        chain.doFilter(request, response);
                                    }
                            
                                    System.out.println("exiting chain!");
                                }
                                ```
                            </md-block>

                            <p class="card-text">Click the buttons on your front-end a few times, and note the <span class="text-danger">logs</span> printed to the console.</p>
                            <md-block>
                                ``` bash
                                    In unauthenticated endpoint
                                    entering chain!
                                    exiting chain!
                                    In unauthenticated endpoint
                                    entering chain!
                                    exiting chain!
                                ```
                            </md-block>

                            <p class="card-text">Now, requests to the auth endpoint are being filtered-out because they don't have a <span class="text-danger">token</span> header.</p>
                        </div>
                    </div>

                    <div id="sample-redirect" class="card" style="width: 60rem;">
                        <div class="card-body">
                            <h5 class="card-title">Sample redirect</h5>
                            <p class="card-text">Login.gov uses <span class="text-danger">redirects</span>, so let's practice making one.</p>
                            <p class="card-text">Add another button to <span class="text-danger">src/main/resources/static/your-application-todo.html</span>.</p>
                            <md-block>
                                ``` html
                                &lt;a class="btn btn-secondary" hx-trigger="click" hx-post="/login">
                                    Login
                                &lt;/a>
                                ```
                            </md-block>

                            <p class="card-text">Add the following two methods to <span class="text-danger">kuhn.example.logingovdemo.YourLoginFilter</span>.</p>
                            <md-block>
                                ``` java
                                @Override
                                public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
                                        throws IOException, ServletException {
                                    ((HttpServletResponse) response).setHeader("HX-Redirect", "https://www.yahoo.com");
                                }
                            
                                @Bean
                                public FilterRegistrationBean<YourLoginFilter> loginFilter() {
                                    FilterRegistrationBean<YourLoginFilter> registrationBean = new FilterRegistrationBean<>();
                                    registrationBean.setFilter(new YourLoginFilter());
                                    registrationBean.addUrlPatterns("/login");
                                    return registrationBean; 
                                }
                                ```
                            </md-block>

                            <p class="card-text">Add the following endpoint to <span class="text-danger">kuhn.example.logingovdemo.YourUnauthenticatedRestController</span>.</p>
                            <md-block>
                                ``` java
                                @PostMapping("/login")
                                public void login() {
                                    System.out.println("login endpoint");
                                }
                                ```
                            </md-block>
                        </div>
                    </div>

                    <div id="real-redirect" class="card" style="width: 60rem;">
                        <div class="card-body">
                            <h5 class="card-title">Redirect - Login phase one</h5>
                            <p class="card-text">Modify <span class="text-danger">kuhn.example.logingovdemo.YourLoginFilter.doFilter()</span> with a real redirect.</p>

                            <md-block>
                                ``` java
                                private final String clientId = "gov:gsa:openidconnect.profiles:sp:sso:tva:kuhn_demo"; // TODO : Replace with your clientId
                                private final String redirectUri = "http://localhost:8080/Redirect"; // TODO : Replace with your Redirect URI
                            
                                @Override
                                public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
                                        throws IOException, ServletException {
                                    System.out.println("enter loginFilter");
                                    final String redirectTo = String.format("https://idp.int.identitysandbox.gov/openid_connect/authorize?"
                                            + "acr_values=http://idmanagement.gov/ns/assurance/ial/1&"
                                            + "client_id=%s&"
                                            + "nonce=$%s&"
                                            + "prompt=select_account&"
                                            + "redirect_uri=%s&"
                                            + "response_type=code&"
                                            + "scope=openid+email&"
                                            + "state=%s", clientId, java.util.UUID.randomUUID(), redirectUri, java.util.UUID.randomUUID()).toString();
                                    System.out.println("redirecting to: " + redirectTo);
                                    ((HttpServletResponse) response).setHeader("HX-Redirect", redirectTo);
                                    chain.doFilter(request, response);
                                    System.out.println("exit loginFilter");
                                }
                                ```
                            </md-block>
                        </div>
                    </div>

                    <div id="real-redirect-result" class="card" style="width: 60rem;">
                        <div class="card-body">
                            <h5 class="card-title">Redirect - Login phase two</h5>
                            <p class="card-text">Add a new endpoint to <span class="text-danger">kuhn.example.logingovdemo.YourUnauthenticatedRestController</span> to handle the redirect back to the your application.</p>

                            <md-block>
                                ``` java
                                private final String clientId = "gov:gsa:openidconnect.profiles:sp:sso:tva:kuhn_demo"; // TODO : Replace with your clientId
                                private final String pemLocation = "classpath:security\\private-kuhn-demo.pem"; // TODO : Replace with your pem
                                private int expirationTime = 1000000; // TODO : Play with this

                                @GetMapping("/Redirect")
                                public void redirect(@RequestParam String code) {
                                    System.out.println("login.gov has redirected back to us with an authorization code: " + code);
                                    final String url = String.format("https://idp.int.identitysandbox.gov/api/openid_connect/token?"
                                            + "client_assertion=%s&"
                                            + "client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer&"
                                            + "code=%s&"
                                            + "grant_type=authorization_code", Utils.createClientAssertion(clientId, expirationTime, pemLocation), code);
                                    System.out.println("Requesting back to login.gov with the authorization code for a jwt token: " + System.lineSeparator() + url);
                                    final String response = restTemplate.postForObject(url, null, String.class);
                                    System.out.println("Result from request to to login.gov for a jwt token: " + System.lineSeparator() + response);
                                }
                                ```
                            </md-block>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</body>
</html>